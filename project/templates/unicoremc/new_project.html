{% extends "unicoremc/base.html" %}
 {% load i18n admin_urls admin_static %}

{% block navbar %}
<ul class="nav" id="main-menu-left">
<li><a href="{% url 'home' %}">Home</a></li>
<li class="active"><a href="#">New Project</a></li>
</ul>
{% endblock %}

{% block content %}
<div id="content-main" class="new-project">
    <div>
    <form class="form-horizontal" role="form">
        <legend>New Project</legend>
        <div class="form-group">
            <label class="col-sm-2 control-label" style="text-align:left">App type</label>
            <div class="col-sm-10">
            <select class="form-control" id="unicore_app">
                <option value="">---------</option>
                {% for app_type in app_types %}
                    <option value="{{app_type.pk}}">{{app_type}}</option>
                {% endfor %}
            </select>
            <span class="help-block">Type of app to create.</span>
            </div>
        </div>
        <div class="form-group">
                <label class="col-sm-2 control-label" style="text-align:left">Base content repo</label>
                <div class="col-sm-10">
                    <select class="form-control" id="base_repo" name="base_repo" disabled="disabled">
                        <option value="">---------</option>
                    </select>
                    <span class="help-block">This is the Content Repo that the site will be based on.</span>
                </div>
        </div>
        <div class="form-group">
                <label class="col-sm-2 control-label" style="text-align:left">Country</label>
                <div class="col-sm-10">
                    <select id="country" disabled="disabled">
                        <option value="">---------</option>
                        {% for code, name in countries %}
                            <option value="{{code}}">{{name}}</option>
                        {% endfor %}
                    </select>
                    <span class="help-block">The country this is intended for. This will inform the url</span>
                </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label" style="text-align:left">Team Permissions</label>
            <div class="col-sm-10">
                <select id="repo_team" name="repo_team" disabled="disabled">
                    <option value="">---------</option>
                </select>
                <span class="help-block">This is the team that will have push access to the repo.</span>
            </div>
        </div>

    <br/>
    <p><input id="btn_launch" type="submit" value="Launch" class="btn btn-primary" name="_launch" disabled="disabled"></p>

    </form>
    </div>
</div>

<script type="text/javascript">
if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}


(function($) {
    function load_content_repos(app_name){
        //javascript goes here
       $.get('/repos/')
            .done(function(data){
                var options = new Array();
                options.push($('<option>').val('').text('---------'));
                $.each(data, function(){
                    if(this.name.startsWith('unicore-cms-content-' + app_name) ||
                        this.name.startsWith('unicore-cms-content-blank')){
                            options.push($('<option>').val(this.git_url).text(this.name));
                    }
                });
                $('#base_repo').html(options).removeAttr('disabled').change();
            });

        $.get('https://api.github.com/orgs/universalcore/teams?access_token={{access_token}}')
            .done(function(data){
                var options = new Array();
                options.push($('<option>').val('').text('---------'));
                $.each(data, function(){
                    options.push($('<option>').val(this.id).text(this.name));
                });
                $('#repo_team').html(options);
            });
    }

    function launch(){
        // Trigger start new project via ajax
        data = {
            'app_type': $('#unicore_app').val(),
            'base_repo': $('#base_repo').val(),
            'country': $('#country').val(),
            'team_id': $('#repo_team').val(),
            'user_id': '{{request.user.id}}',
            'access_token': '{{access_token}}'
        }
        $.post('/new/create/', data)
            .done(function(){
                window.location = '/';
            });
    }

    $(document).ready(function() {
        $('#unicore_app').change(function(){
            if($(this).val() != '')
                load_content_repos($(this).val());
            else{
                $("#base_repo").attr('disabled', 'disabled').val('').change();
            }
        });
        $('#base_repo').change(function(){
            if($(this).val() != '')
                $("#country").removeAttr('disabled');
            else{
                $("#country").attr('disabled', 'disabled').val('').change();
            }
        });

        $('#country').change(function(){
            if($(this).val() != '')
                $("#repo_team").removeAttr('disabled');
            else
                $("#repo_team").attr('disabled', 'disabled');
        });

        $('#repo_team').change(function(){
            if($(this).val() != '')
                $("#btn_launch").removeAttr('disabled');
            else
                $("#btn_launch").attr('disabled', 'disabled');
        });

        $("#btn_launch").click(function(event){
            event.preventDefault();
            $(this).attr('disabled', 'disabled');
            launch();
        });
    });
})($);
</script>
{% endblock%}
