{% extends "unicoremc/base.html" %}

<!-- LOADING -->
{% load i18n controller_base_tags %}

{% block results_count %}
<div class="pull-left results-count">
<code id="results_count">{{controller_list.count}}</code>
<span>results</span>
</div>
{% endblock %}

<!-- CONTENT -->
{% block content %}

{% if user.is_superuser %}
<a href="{% url 'base:add' %}" class="btn btn-primary">Start new base controller</a>
<a href="{% url 'controllers.docker:add' %}" class="btn btn-primary">Start new docker controller</a>
{% comment %}
<a href="{% url 'manage_ga' %}" class="btn btn-primary">Manage GA Profiles</a>
<a href="{% url 'health_check' %}" class="btn btn-primary">Health Checks</a>
{% endcomment %}
{% endif %}

<div id="projects_progress">
    <section id="grp-changelist">
    <div>
      <div class="heading">App Type</div>
      <div class="heading">App ID</div>
      <div class="heading">Status</div>
      <br style="clear:both"/>
      <div id="result_list">
      {% for controller in controller_list %}
      {% render_controller controller %}
      {% endfor %}
      </div>
    </div>
    </section>
</div>
{% endblock %}

{% block script %}
<script src="{{STATIC_URL}}js/jquery.min.js"></script>
<script src="{{STATIC_URL}}js/ws4redis.min.js"></script>
<script type="text/javascript">

jQuery(document).ready(function($) {
    var ws4redis = WS4Redis({
        uri: '{{ WEBSOCKET_URI }}progress?subscribe-broadcast',
        receive_message: receiveMessage,
        heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
    });

    // receive a message though the websocket from the server
    function receiveMessage(msg) {
      var data = JSON.parse(msg);
      if (data.is_created && document.getElementById(data.id) == null){
        //reload page when new project added
        window.location.reload();
        return
      }

      $('#'+data.id).attr('class', 'main '+ data.state);
      $('#'+data.id+' .state').html(data.state_display);
    }

    $("#result_list .main")
    .on("mouseenter", function(){
      $(this).addClass("info-hint");
    })
    .on("mouseleave", function(){
      $(this).removeClass("info-hint");
    })
    .on("click", function(e){
      if(!$(e.target).is("a")){
        $(this).find(".additional-info").toggle(400);
      }
    });

    $('#filter').keyup(function(){
        var valThis = $(this).val().toLowerCase().split(" ");
        $('#result_list .main').each(function(){
            var text = $(this).attr('name') + ' ' +
                       $(this).attr('appid') + ' ' +
                       $(this).attr('state');
            valThis.every(function(a){return text.toLowerCase().indexOf(a) != -1}) ? $(this).show() : $(this).hide();
        });
        $("#results_count").html($('#result_list .main:visible').length);
    });
});
</script>
{% endblock %}
