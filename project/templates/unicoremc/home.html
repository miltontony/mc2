{% extends "unicoremc/base.html" %}

<!-- LOADING -->
{% load i18n %}

<!-- CONTENT -->
{% block content %}

{% if user.is_superuser %}
<a href="{% url 'new_project' %}" class="btn btn-primary">Start new project</a>
<a href="{% url 'manage_ga' %}" class="btn btn-primary">Manage GA Profiles</a>
{% endif %}

<div id="projects_progress">
    <section id="grp-changelist">
    <div class="grp-module grp-changelist-results">
        <table id="result_list" cellspacing="0" class="table table-striped table-hover table-condensed">
            <thead>
                <tr>
                    <th scope="col">
                        <div class="grp-text">App Type</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">Country</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">Status</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">Content Store</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">Frontend URL <br />*.hub.unicore.io</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">CMS URL <br />*.hub.unicore.io</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">Languages</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">GA Profile</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">Hub App ID</div>
                    </th>
                </tr>
            </thead>
            <tbody>
            {% for project in project_list %}
            {% include 'unicoremc/project_object.html' %}
            {% endfor %}
            </tbody>
        </table>
    </div>
    </section>
</div>
{% endblock %}

{% block script %}
<script src="{{STATIC_URL}}js/jquery.min.js"></script>
<script src="{{STATIC_URL}}js/ws4redis.js"></script>
<script type="text/javascript">

jQuery(document).ready(function($) {
    var ws4redis = WS4Redis({
        uri: '{{ WEBSOCKET_URI }}progress?subscribe-broadcast',
        receive_message: receiveMessage,
        heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
    });

    // receive a message though the websocket from the server
    function receiveMessage(msg) {
      var data = JSON.parse(msg);

      if (document.getElementById(data.id) == null){
        //project is probably new
        window.location.reload();
        return
      }

      $('#'+data.id).attr('class', data.state);
      $('#'+data.id+' .state').html(data.state_display);

      var languages = new Array();
      $.each(data.available_languages, function(){
        var lang_link = $('<a/>')
          .attr('target', '_blank')
          .attr('href', data.frontend_url+'/locale/' + this + '/')
          .html(this + ',&nbsp;');
        if (this == data.default_language){
          lang_link.addClass('active');
        }
        languages.push(lang_link);
      });
      $('#'+data.id+' .languages').html(languages);
    }
});
</script>
{% endblock %}
