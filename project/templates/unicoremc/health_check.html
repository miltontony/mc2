{% extends "unicoremc/base.html" %}
 {% load i18n admin_urls admin_static %}

{% block navbar %}
<ul class="nav" id="main-menu-left">
<li><a href="{% url 'home' %}">Home</a></li>
<li class="active"><a href="#">Health checks</a></li>
</ul>
{% endblock %}

{% block content %}
<div id="content-main">
    <div>
        {% csrf_token %}
        <table id="result_list" cellspacing="0" class="table table-striped table-hover table-condensed">
            {% comment %}
            <thead>
                <tr>
                    <th scope="col">
                        <div class="grp-text">App Type</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">URL</div>
                    </th>
                    <th scope="col">
                        <div class="grp-text">Status</div>
                    </th>
                </tr>
            </thead>
            {% endcomment %}
            <tbody>
            {% for p in project_list %}
            <tr id="{{p.id}}">
                <td>{{p.application_type.title}} - {{p.get_country_display}}</td>
                <td><a href="http://{{p.get_generic_domain}}{{p.marathon_health_check_path}}" target="_blank">{{p.marathon_health_check_path}}</td>
                <td class="health"><span class="label">unknown</span></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script type="text/javascript">
    function check_health(project_id){
        $.get('/health/' + project_id + '/')
            .done(function(response){
                $("#"+project_id+" .health .label")
                  .html("active")
                  .addClass("label-success")
                  .removeClass("label-warning");
            })
            .fail(function(response){
                console.log(response.status);
                var msg = response.status == 400? 'unknown' : 'site down';
                var state = response.status == 400? 'label label-warning' : ' label label-important';
                $("#"+project_id+" .health .label")
                  .html(msg)
                  .attr("class", state);
            });
    }

    function check_all_health(){
      $('tr').each(function(index){
          var id = $(this).attr('id');
          check_health(id);
      });
    }

    $(function(){
      check_all_health();
    });
</script>
{% endblock %}
